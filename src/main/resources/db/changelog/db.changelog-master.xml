<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <include file="db/changelog/001-create-initial-schema.xml"/>
    <include file="db/changelog/002-insert-default-roles.xml"/>
    <include file="db/changelog/003-create-indexes.xml"/>

</databaseChangeLog>

        <!-- 001-create-initial-schema.xml -->
        <?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

<changeSet id="001-create-users-table" author="developer">
    <createTable tableName="users">
        <column name="id" type="BIGSERIAL" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="username" type="VARCHAR(50)">
            <constraints nullable="false" unique="true"/>
        </column>
        <column name="email" type="VARCHAR(100)">
            <constraints nullable="false" unique="true"/>
        </column>
        <column name="password" type="VARCHAR(255)">
            <constraints nullable="false"/>
        </column>
        <column name="first_name" type="VARCHAR(50)"/>
        <column name="last_name" type="VARCHAR(50)"/>
        <column name="phone_number" type="VARCHAR(20)"/>
        <column name="enabled" type="BOOLEAN" defaultValueBoolean="false">
            <constraints nullable="false"/>
        </column>
        <column name="account_non_expired" type="BOOLEAN" defaultValueBoolean="true">
            <constraints nullable="false"/>
        </column>
        <column name="account_non_locked" type="BOOLEAN" defaultValueBoolean="true">
            <constraints nullable="false"/>
        </column>
        <column name="credentials_non_expired" type="BOOLEAN" defaultValueBoolean="true">
            <constraints nullable="false"/>
        </column>
        <column name="email_verified_at" type="TIMESTAMP"/>
        <column name="last_login_at" type="TIMESTAMP"/>
        <column name="password_changed_at" type="TIMESTAMP"/>
        <column name="password_reset_token" type="VARCHAR(255)"/>
        <column name="password_reset_token_expiry" type="TIMESTAMP"/>
        <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
            <constraints nullable="false"/>
        </column>
        <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>

    <addUniqueConstraint tableName="users" columnNames="username" constraintName="uk_users_username"/>
    <addUniqueConstraint tableName="users" columnNames="email" constraintName="uk_users_email"/>
</changeSet>

<changeSet id="002-create-roles-table" author="developer">
    <createTable tableName="roles">
        <column name="id" type="BIGSERIAL" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="name" type="VARCHAR(50)">
            <constraints nullable="false" unique="true"/>
        </column>
        <column name="description" type="VARCHAR(255)"/>
        <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
            <constraints nullable="false"/>
        </column>
    </createTable>

    <addUniqueConstraint tableName="roles" columnNames="name" constraintName="uk_roles_name"/>
</changeSet>

<changeSet id="003-create-user-roles-table" author="developer">
    <createTable tableName="user_roles">
        <column name="user_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
        <column name="role_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
    </createTable>

    <addPrimaryKey tableName="user_roles" columnNames="user_id,role_id" constraintName="pk_user_roles"/>

    <addForeignKeyConstraint
            baseTableName="user_roles" baseColumnNames="user_id"
            referencedTableName="users" referencedColumnNames="id"
            constraintName="fk_user_roles_user"
            onDelete="CASCADE"/>

    <addForeignKeyConstraint
            baseTableName="user_roles" baseColumnNames="role_id"
            referencedTableName="roles" referencedColumnNames="id"
            constraintName="fk_user_roles_role"
            onDelete="CASCADE"/>
</changeSet>

<changeSet id="004-create-refresh-tokens-table" author="developer">
    <createTable tableName="refresh_tokens">
        <column name="id" type="BIGSERIAL" autoIncrement="true">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="token" type="VARCHAR(512)">
            <constraints nullable="false" unique="true"/>
        </column>
        <column name="user_id" type="BIGINT">
            <constraints nullable="false"/>
        </column>
        <column name="expiry_date" type="TIMESTAMP">
            <constraints nullable="false"/>
        </column>
        <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
            <constraints nullable="false"/>
        </column>
    </createTable>

    <addUniqueConstraint tableName="refresh_tokens" columnNames="token" constraintName="uk_refresh_tokens_token"/>

    <addForeignKeyConstraint
            baseTableName="refresh_tokens" baseColumnNames="user_id"
            referencedTableName="users" referencedColumnNames="id"
            constraintName="fk_refresh_tokens_user"
            onDelete="CASCADE"/>
</changeSet>

</databaseChangeLog>

        <!-- 002-insert-default-roles.xml -->
        <?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

<changeSet id="005-insert-default-roles" author="developer">
    <insert tableName="roles">
        <column name="name" value="ROLE_USER"/>
        <column name="description" value="Default user role with basic permissions"/>
    </insert>

    <insert tableName="roles">
        <column name="name" value="ROLE_ADMIN"/>
        <column name="description" value="Administrator role with full permissions"/>
    </insert>

    <insert tableName="roles">
        <column name="name" value="ROLE_MODERATOR"/>
        <column name="description" value="Moderator role with limited admin permissions"/>
    </insert>
</changeSet>

</databaseChangeLog>

        <!-- 003-create-indexes.xml -->
        <?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

<changeSet id="006-create-performance-indexes" author="developer">
    <!-- User table indexes -->
    <createIndex tableName="users" indexName="idx_users_email">
        <column name="email"/>
    </createIndex>

    <createIndex tableName="users" indexName="idx_users_username">
        <column name="username"/>
    </createIndex>

    <createIndex tableName="users" indexName="idx_users_enabled">
        <column name="enabled"/>
    </createIndex>

    <createIndex tableName="users" indexName="idx_users_created_at">
        <column name="created_at"/>
    </createIndex>

    <createIndex tableName="users" indexName="idx_users_last_login_at">
        <column name="last_login_at"/>
    </createIndex>

    <!-- Role table indexes -->
    <createIndex tableName="roles" indexName="idx_roles_name">
        <column name="name"/>
    </createIndex>

    <!-- User roles table indexes -->
    <createIndex tableName="user_roles" indexName="idx_user_roles_user_id">
        <column name="user_id"/>
    </createIndex>

    <createIndex tableName="user_roles" indexName="idx_user_roles_role_id">
        <column name="role_id"/>
    </createIndex>

    <!-- Refresh tokens table indexes -->
    <createIndex tableName="refresh_tokens" indexName="idx_refresh_tokens_token">
        <column name="token"/>
    </createIndex>

    <createIndex tableName="refresh_tokens" indexName="idx_refresh_tokens_user_id">
        <column name="user_id"/>
    </createIndex>

    <createIndex tableName="refresh_tokens" indexName="idx_refresh_tokens_expiry_date">
        <column name="expiry_date"/>
    </createIndex>

    <createIndex tableName="refresh_tokens" indexName="idx_refresh_tokens_created_at">
        <column name="created_at"/>
    </createIndex>
</changeSet>

</databaseChangeLog>